<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gompertz æ›²ç·šå»ºæ¨¡å¹³å° - å¹³å°ä»‹å…¥æ•ˆæ‡‰åˆ†æ</title>
    
    <!-- ========================================
         SINGLE STYLE BLOCK - NO DUPLICATES
         ======================================== -->
    <style>
/* ========================================
   1. CSS VARIABLES & ROOT
   ======================================== */
:root {
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);

  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;
    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);
    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
}

/* ========================================
   2. GLOBAL STYLES
   ======================================== */
html {
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
}

*, *::before, *::after {
  box-sizing: inherit;
}

h1, h2, h3, h4, h5, h6 {
  margin: 0;
  font-weight: var(--font-weight-semibold);
  line-height: var(--line-height-tight);
  color: var(--color-text);
  letter-spacing: var(--letter-spacing-tight);
}

h1 { font-size: var(--font-size-4xl); }
h2 { font-size: var(--font-size-3xl); }
h3 { font-size: var(--font-size-2xl); }
h4 { font-size: var(--font-size-xl); }
h5 { font-size: var(--font-size-lg); }
h6 { font-size: var(--font-size-md); }

p { margin: 0 0 var(--space-16) 0; }

/* ========================================
   3. COMMON ELEMENTS
   ======================================== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-8) var(--space-16);
  border-radius: var(--radius-base);
  font-size: var(--font-size-base);
  font-weight: 500;
  line-height: 1.5;
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  border: none;
  text-decoration: none;
}

.btn:focus-visible {
  outline: none;
  box-shadow: var(--focus-ring);
}

.btn--primary {
  background: var(--color-primary);
  color: var(--color-btn-primary-text);
}

.btn--primary:hover {
  background: var(--color-primary-hover);
}

.btn--secondary {
  background: var(--color-secondary);
  color: var(--color-text);
}

.btn--secondary:hover {
  background: var(--color-secondary-hover);
}

.btn--outline {
  background: transparent;
  border: 1px solid var(--color-border);
  color: var(--color-text);
}

.btn--outline:hover {
  background: var(--color-secondary);
}

.btn--sm {
  padding: var(--space-4) var(--space-12);
  font-size: var(--font-size-sm);
}

.button-group {
  display: flex;
  gap: var(--space-8);
  flex-wrap: wrap;
}

.form-control {
  display: block;
  width: 100%;
  padding: var(--space-8) var(--space-12);
  font-size: var(--font-size-md);
  line-height: 1.5;
  color: var(--color-text);
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  transition: border-color var(--duration-fast) var(--ease-standard);
}

.form-control:focus {
  border-color: var(--color-primary);
  outline: var(--focus-outline);
}

textarea.form-control {
  font-family: var(--font-family-mono);
  resize: vertical;
}

.form-label {
  display: block;
  margin-bottom: var(--space-8);
  font-weight: var(--font-weight-medium);
  font-size: var(--font-size-sm);
}

.form-group {
  margin-bottom: var(--space-16);
}

/* ========================================
   4. LAYOUT SECTIONS
   ======================================== */
.container {
  width: 100%;
  max-width: 1400px;
  margin: 0 auto;
  padding: var(--space-24);
}

.app-header {
  text-align: center;
  margin-bottom: var(--space-32);
  padding-bottom: var(--space-24);
  border-bottom: 1px solid var(--color-border);
}

.subtitle {
  color: var(--color-text-secondary);
  font-size: var(--font-size-lg);
  margin-top: var(--space-8);
}

.section {
  margin-bottom: var(--space-32);
}

.section-header {
  margin-bottom: var(--space-24);
}

.section-header h2 {
  margin-bottom: var(--space-8);
}

.section-header p {
  color: var(--color-text-secondary);
  margin: 0;
}

.card {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  margin-bottom: var(--space-16);
}

.card__header {
  padding: var(--space-16);
  border-bottom: 1px solid var(--color-card-border-inner);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card__header h3 {
  margin: 0;
  font-size: var(--font-size-xl);
}

.card__body {
  padding: var(--space-16);
}

.settings-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-16);
}

.action-buttons {
  display: flex;
  gap: var(--space-12);
  justify-content: flex-end;
  margin-top: var(--space-24);
}

/* ========================================
   5. PROGRESS STEPS
   ======================================== */
.progress-steps {
  display: flex;
  justify-content: space-between;
  margin-bottom: var(--space-32);
  position: relative;
}

.progress-steps::before {
  content: '';
  position: absolute;
  top: 20px;
  left: 0;
  right: 0;
  height: 2px;
  background: var(--color-border);
  z-index: 0;
}

.step {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  z-index: 1;
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--color-surface);
  border: 2px solid var(--color-border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-8);
  transition: all var(--duration-normal) var(--ease-standard);
}

.step-label {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.step.active .step-number {
  background: var(--color-primary);
  border-color: var(--color-primary);
  color: var(--color-btn-primary-text);
}

.step.completed .step-number {
  background: var(--color-success);
  border-color: var(--color-success);
  color: var(--color-btn-primary-text);
}

/* ========================================
   6. DATA QUALITY & TABLES
   ======================================== */
.table-container {
  overflow-x: auto;
  max-height: 400px;
  overflow-y: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: var(--font-size-sm);
}

.data-table th,
.data-table td {
  padding: var(--space-8) var(--space-12);
  text-align: left;
  border-bottom: 1px solid var(--color-card-border-inner);
}

.data-table th {
  font-weight: var(--font-weight-semibold);
  background: var(--color-bg-1);
  position: sticky;
  top: 0;
  z-index: 1;
}

.data-table tbody tr:hover {
  background: var(--color-bg-2);
}

.quality-score-container {
  background: var(--color-bg-1);
  padding: var(--space-16);
  border-radius: var(--radius-base);
  margin-bottom: var(--space-16);
}

.quality-score-bar {
  height: 24px;
  background: var(--color-secondary);
  border-radius: var(--radius-full);
  overflow: hidden;
  margin-bottom: var(--space-8);
  position: relative;
}

.quality-score-fill {
  height: 100%;
  background: var(--color-success);
  transition: width var(--duration-normal) var(--ease-standard);
  border-radius: var(--radius-full);
}

.quality-score-value {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-semibold);
  text-align: center;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  padding: var(--space-4) var(--space-8);
  border-radius: var(--radius-sm);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
  gap: var(--space-4);
}

.status-badge.valid {
  background: rgba(var(--color-success-rgb), 0.15);
  color: var(--color-success);
}

.status-badge.missing {
  background: rgba(var(--color-warning-rgb), 0.15);
  color: var(--color-warning);
}

/* ========================================
   7. CHARTS & VISUALIZATION
   ======================================== */
.chart-container {
  position: relative;
  height: 400px;
  width: 100%;
}

.params-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: var(--space-16);
  margin-bottom: var(--space-24);
}

.param-card {
  background: var(--color-bg-1);
  padding: var(--space-16);
  border-radius: var(--radius-base);
  border: 1px solid var(--color-card-border);
}

.param-label {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-4);
}

.param-value {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-4);
}

.scenarios-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--space-16);
}

.scenario-card {
  background: var(--color-surface);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-lg);
  padding: var(--space-16);
}

.scenario-card h3 {
  margin-bottom: var(--space-16);
  padding-bottom: var(--space-8);
  border-bottom: 1px solid var(--color-card-border-inner);
}

.slider {
  width: 100%;
  height: 6px;
  border-radius: var(--radius-full);
  background: var(--color-secondary);
  outline: none;
  appearance: none;
  -webkit-appearance: none;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--color-primary);
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: var(--color-primary);
  cursor: pointer;
  border: none;
}

/* ========================================
   8. UTILITY CLASSES
   ======================================== */
.hidden {
  display: none !important;
}

.error-message {
  color: var(--color-error);
  padding: var(--space-12);
  background: rgba(var(--color-error-rgb), 0.1);
  border-radius: var(--radius-base);
  margin-top: var(--space-16);
}

.status-message {
  color: var(--color-info);
  padding: var(--space-12);
  background: var(--color-bg-3);
  border-radius: var(--radius-base);
  text-align: center;
}

.toast {
  position: fixed;
  top: var(--space-20);
  right: var(--space-20);
  padding: var(--space-12) var(--space-16);
  background: var(--color-charcoal-700);
  color: var(--color-cream-50);
  border-radius: var(--radius-base);
  box-shadow: var(--shadow-lg);
  z-index: 9999;
  animation: slideIn 0.3s ease-out;
  font-size: var(--font-size-sm);
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ========================================
   9. NEW INTERPOLATION STYLES
   ======================================== */
.status-badge.interpolated {
  background: rgba(var(--color-teal-500-rgb), 0.15);
  color: var(--color-primary);
}

.interpolation-options {
  display: grid;
  gap: var(--space-12);
}

.interpolation-option {
  display: flex;
  align-items: flex-start;
  padding: var(--space-12);
  border-radius: var(--radius-base);
  border: 1px solid var(--color-border);
  background: var(--color-bg-1);
}

.interpolation-option input {
  margin-top: var(--space-4);
  margin-right: var(--space-12);
}

.interpolation-option label {
  margin: 0;
  font-weight: var(--font-weight-medium);
}

.interpolation-option label span {
  display: block;
  font-weight: var(--font-weight-normal);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
}

.impact-box {
  margin-top: var(--space-16);
  padding: var(--space-12);
  border-radius: var(--radius-base);
  background: var(--color-bg-3);
  border: 1px solid rgba(var(--color-success-rgb), 0.2);
}

.param-input {
  width: 100%;
  background: var(--color-bg-1);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  padding: var(--space-8);
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text);
  font-family: var(--font-family-mono);
}
.param-input:focus {
  background: var(--color-surface);
  border-color: var(--color-primary);
  outline: var(--focus-outline);
}

   @media (max-width: 768px) {
  .container {
    padding: var(--space-16);
  }

  .progress-steps {
    flex-wrap: wrap;
  }

  .step-label {
    font-size: var(--font-size-xs);
  }

  .scenarios-container {
    grid-template-columns: 1fr;
  }

  .settings-grid,
  .params-grid {
    grid-template-columns: 1fr;
  }

  .chart-container {
    height: 300px;
  }
}
    </style>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <h1>Gompertz æ›²ç·šå»ºæ¨¡å¹³å°</h1>
            <p class="subtitle">å¹³å°ä»‹å…¥æ•ˆæ‡‰åˆ†æèˆ‡é æ¸¬ç³»çµ±</p>
        </header>

        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">æ•¸æ“šè¼¸å…¥</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">åŸºç·šæ“¬åˆ</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">æƒ…å¢ƒé…ç½®</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">çµæœåˆ†æ</div>
            </div>
        </div>

        <!-- Step 1: Data Input -->
        <div class="section" id="step1">
            <div class="section-header">
                <h2>æ­¥é©Ÿ 1: æ•¸æ“šè¼¸å…¥</h2>
                <p>è¼¸å…¥æ­·å²æ™‚é–“åºåˆ—æ•¸æ“š</p>
            </div>

            <div class="card">
                <div class="card__body">
                    <div class="form-group">
                        <label class="form-label">æ•¸æ“šè¼¸å…¥æ–¹å¼</label>
                        <div class="button-group">
                            <button class="btn btn--secondary" id="loadSampleBtn">è¼‰å…¥ç¯„ä¾‹æ•¸æ“š</button>
                            <button class="btn btn--outline" id="clearDataBtn">æ¸…é™¤æ•¸æ“š</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="dataInput">è²¼ä¸Šæ•¸æ“š (æ ¼å¼: æœŸé–“,å¸³æˆ¶æ•¸)</label>
                        <textarea class="form-control" id="dataInput" rows="8" placeholder="Q1 2020,28988&#10;Q2 2020,75699&#10;Q3 2020,170312&#10;..."></textarea>
                        <div class="error-message" id="dataError" style="display: none; margin-top: var(--space-16);"></div>
                    </div>

                    <div class="settings-grid">
                        <div class="form-group">
                            <label class="form-label" for="forecastYears">é æ¸¬å¹´æ•¸</label>
                            <input type="number" class="form-control" id="forecastYears" value="8" min="1" max="20">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="dataQualityCard" style="display: none;">
                <div class="card__header">
                    <h3>æ•¸æ“šå“è³ªå ±å‘Š</h3>
                </div>
                <div class="card__body">
                    <div class="quality-score-container">
                        <div class="quality-score-bar">
                            <div class="quality-score-fill" id="qualityScoreFill"></div>
                        </div>
                        <div class="quality-score-value" id="qualityScoreValue">--/100</div>
                    </div>
                    <div id="qualityIssues"></div>
                </div>
            </div>

            <div class="card" id="missingDataCard" style="display: none;">
                <div class="card__header">
                    <h3>ç¼ºæ¼æ•¸æ“šè™•ç†</h3>
                </div>
                <div class="card__body">
                    <p style="color: var(--color-text-secondary); margin-bottom: var(--space-16);">åµæ¸¬åˆ°æ•¸æ“šç¼ºæ¼ã€‚è«‹é¸æ“‡ä¸€ç¨®è™•ç†æ–¹æ³•ï¼š</p>
                    
                    <div class="interpolation-options">
                        <div class="interpolation-option">
                            <input type="radio" id="interp_ignore" name="interpolation" value="ignore" checked>
                            <label for="interp_ignore">
                                å¿½ç•¥ (Ignore)
                                <span>è·³éç¼ºæ¼å­£åº¦ (é©ç”¨æ–¼ 1-2 å€‹ç¼ºæ¼)</span>
                            </label>
                        </div>
                        <div class="interpolation-option">
                            <input type="radio" id="interp_linear" name="interpolation" value="linear">
                            <label for="interp_linear">
                                ç·šæ€§æ’å€¼ (Linear)
                                <span>åœ¨ç›¸é„°å€¼ä¹‹é–“ç¹ªè£½ç›´ç·š</span>
                            </label>
                        </div>
                        <div class="interpolation-option">
                            <input type="radio" id="interp_gompertz" name="interpolation" value="gompertz">
                            <label for="interp_gompertz">
                                Gompertz æ’å€¼
                                <span>ä½¿ç”¨åˆæ­¥æ“¬åˆä¼°è¨ˆç¼ºæ¼å€¼ - æœ€é©åˆæˆé•·æ•¸æ“š</span>
                            </label>
                        </div>
                        <div class="interpolation-option">
                            <input type="radio" id="interp_forward" name="interpolation" value="forward">
                            <label for="interp_forward">
                                å‘å‰å¡«å…… (Forward-Fill)
                                <span>é‡è¤‡å‰ä¸€å€‹å€¼ (ä¿å®ˆæ–¹æ³•)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="impact-box" id="interpolationImpact" style="display: none;">
                        <h4>æ–¹æ³•èªªæ˜</h4>
                        <p>è·³éç¼ºæ¼å­£åº¦ã€‚å¦‚æœç¼ºæ¼è¼ƒå°‘ï¼ˆ1-2å€‹ï¼‰ï¼Œé€™æ˜¯å¯è¡Œçš„ç°¡å–®æ–¹æ³•ã€‚</p>
                    </div>
                    
                    <button class="btn btn--secondary" id="applyInterpolationBtn" style="margin-top: var(--space-16);">å¥—ç”¨æ–¹æ³•</button>
                </div>
            </div>

            <div class="card" id="bestPracticesCard" style="display: none;">
                <div class="card__header">
                    <h3>ğŸ’¡ æœ€ä½³å¯¦è¸</h3>
                </div>
                <div class="card__body">
                    <p style="margin: 0;"><strong>Gompertz æ’å€¼</strong> é€šå¸¸æ˜¯ S å‹æˆé•·æ•¸æ“šæœ€æº–ç¢ºçš„æ–¹æ³•ã€‚<strong>ç·šæ€§æ’å€¼</strong> é©ç”¨æ–¼è¶¨å‹¢ç©©å®šçš„æ™‚æœŸã€‚<strong>å¿½ç•¥</strong> å‰‡æœƒå°è‡´æ“¬åˆæ™‚ä½¿ç”¨è¼ƒå°‘çš„æ•¸æ“šé»ã€‚</p>
                </div>
            </div> <div class="card" id="dataPreviewCard" style="display: none;">
                <div class="card__header">
                    <h3>æ•¸æ“šé è¦½</h3>
                </div>
                <div class="card__body">
                    <div class="table-container">
                        <table class="data-table" id="dataPreviewTable">
                            <thead>
                                <tr>
                                    <th>æœŸé–“</th>
                                    <th>å¯¦éš›æ•¸å€¼</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>ç•°å¸¸å€¼</th>
                                    <th>å»ºè­°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn--primary" id="validateDataBtn">åˆ†ææ•¸æ“šä¸¦ç¹¼çºŒ</button>
            </div>

        </div>

        <!-- Step 2: Baseline Fitting -->
        <div class="section" id="step2" style="display: none;">
            <div class="section-header">
                <h2>æ­¥é©Ÿ 2: åŸºç·šæ¨¡å‹æ“¬åˆ</h2>
                <p>è‡ªå‹•æ“¬åˆ Gompertz æ›²ç·š</p>
            </div>

            <div class="card">
                <div class="card__header">
                    <h3>æ“¬åˆåƒæ•¸</h3>
                </div>
                <div class="card__body">
                    <div id="fittingStatus" class="status-message">æ­£åœ¨æ“¬åˆæ¨¡å‹...</div>
                    <div id="parametersDisplay" style="display: none;">
                      <div class="params-grid">
                          <div class="param-card">
                              <div class="param-label">K (æ‰¿è¼‰å®¹é‡ / TAM)</div>
                              <input type="number" class="param-input" id="inputParamK">
                              <button class="btn btn--secondary btn--sm" id="refitKBtn" style="margin-top: var(--space-8); width: 100%;">å›ºå®š K ä¸¦é‡æ–°æ“¬åˆ b, tâ‚€</button>
                          </div>
                          <div class="param-card">
                              <div class="param-label">b (æˆé•·ç‡)</div>
                              <input type="number" step="0.001" class="param-input" id="inputParamB">
                          </div>
                          <div class="param-card">
                              <div class="param-label">tâ‚€ (è½‰æŠ˜é»)</div>
                              <input type="number" step="0.01" class="param-input" id="inputParamT0">
                          </div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card__header">
                    <h3>æ“¬åˆçµæœå¯è¦–åŒ–</h3>
                </div>
                <div class="card__body">
                    <div class="chart-container">
                        <canvas id="fittingChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn--outline" id="backToStep1">è¿”å›</button>
                <button class="btn btn--primary" id="proceedToStep3">ç¹¼çºŒé…ç½®æƒ…å¢ƒ</button>
            </div>
        </div>

        <!-- Step 3: Scenario Configuration -->
        <div class="section" id="step3" style="display: none;">
            <div class="section-header">
                <h2>æ­¥é©Ÿ 3: å¹³å°åŠ é€Ÿåƒæ•¸é…ç½®</h2>
                <p>é…ç½®å¹³å°å°æ¡ç”¨é€Ÿåº¦çš„åŠ é€Ÿæ•ˆæ‡‰</p>
            </div>

            <div class="card">
                <div class="card__body">
                    <div class="form-group">
                        <label class="form-label">é è¨­æƒ…å¢ƒ</label>
                        <div class="button-group">
                            <button class="btn btn--secondary scenario-preset" data-scenario="conservative">ä¿å®ˆå‹</button>
                            <button class="btn btn--secondary scenario-preset" data-scenario="moderate">ç©©å¥å‹</button>
                            <button class="btn btn--secondary scenario-preset" data-scenario="aggressive">ç©æ¥µå‹</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="platformLaunch">å¹³å°å•Ÿå‹•å­£åº¦ <span id="launchQuarterLabel">ï¼ˆQ1 2025 = å­£åº¦ 1ï¼‰</span></label>
                        <input type="number" class="form-control" id="platformLaunch" value="3" min="1">
                    </div>
                </div>
            </div>

            <div class="scenarios-container">
                <div class="scenario-card" data-scenario="conservative">
                    <h3 style="color: #3b82f6;">ä¿å®ˆå‹æƒ…å¢ƒ</h3>
                    <div class="param-sliders">
                        <div class="slider-group">
                            <label>Î± (æˆé•·åŠ é€Ÿç‡): <span id="alpha_conservative_val">10</span>%</label>
                            <input type="range" class="slider" id="alpha_conservative" min="0" max="50" step="1" value="10">
                        </div>
                        <div class="slider-group">
                            <label>H (åŠ é€ŸåŠè¡°æœŸ): <span id="half_life_conservative_val">6</span> å­£åº¦</label>
                            <input type="range" class="slider" id="half_life_conservative" min="2" max="16" step="1" value="6">
                        </div>
                        <div class="slider-group">
                            <label>Î”t (æ‹é»å‰ç§»): <span id="delta_t_conservative_val">0.5</span> å­£åº¦</label>
                            <input type="range" class="slider" id="delta_t_conservative" min="0" max="4" step="0.25" value="0.5">
                        </div>
                        <div class="slider-group">
                            <label>Îº (TAM æ“´å¼µ): <span id="kappa_conservative_val">2</span>%</label>
                            <input type="range" class="slider" id="kappa_conservative" min="0" max="20" step="1" value="2">
                        </div>
                    </div>
                </div>

                <div class="scenario-card" data-scenario="moderate">
                    <h3 style="color: #10b981;">ç©©å¥å‹æƒ…å¢ƒ</h3>
                    <div class="param-sliders">
                        <div class="slider-group">
                            <label>Î± (æˆé•·åŠ é€Ÿç‡): <span id="alpha_moderate_val">20</span>%</label>
                            <input type="range" class="slider" id="alpha_moderate" min="0" max="50" step="1" value="20">
                        </div>
                        <div class="slider-group">
                            <label>H (åŠ é€ŸåŠè¡°æœŸ): <span id="half_life_moderate_val">8</span> å­£åº¦</label>
                            <input type="range" class="slider" id="half_life_moderate" min="2" max="16" step="1" value="8">
                        </div>
                         <div class="slider-group">
                            <label>Î”t (æ‹é»å‰ç§»): <span id="delta_t_moderate_val">1.0</span> å­£åº¦</label>
                            <input type="range" class="slider" id="delta_t_moderate" min="0" max="4" step="0.25" value="1.0">
                        </div>
                        <div class="slider-group">
                            <label>Îº (TAM æ“´å¼µ): <span id="kappa_moderate_val">5</span>%</label>
                            <input type="range" class="slider" id="kappa_moderate" min="0" max="20" step="1" value="5">
                        </div>
                    </div>
                </div>

                <div class="scenario-card" data-scenario="aggressive">
                    <h3 style="color: #ef4444;">ç©æ¥µå‹æƒ…å¢ƒ</h3>
                    <div class="param-sliders">
                        <div class="slider-group">
                            <label>Î± (æˆé•·åŠ é€Ÿç‡): <span id="alpha_aggressive_val">35</span>%</label>
                            <input type="range" class="slider" id="alpha_aggressive" min="0" max="50" step="1" value="35">
                        </div>
                        <div class="slider-group">
                            <label>H (åŠ é€ŸåŠè¡°æœŸ): <span id="half_life_aggressive_val">10</span> å­£åº¦</label>
                            <input type="range" class="slider" id="half_life_aggressive" min="2" max="16" step="1" value="10">
                        </div>
                         <div class="slider-group">
                            <label>Î”t (æ‹é»å‰ç§»): <span id="delta_t_aggressive_val">1.5</span> å­£åº¦</label>
                            <input type="range" class="slider" id="delta_t_aggressive" min="0" max="4" step="0.25" value="1.5">
                        </div>
                        <div class="slider-group">
                            <label>Îº (TAM æ“´å¼µ): <span id="kappa_aggressive_val">8</span>%</label>
                            <input type="range" class="slider" id="kappa_aggressive" min="0" max="20" step="1" value="8">
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn--outline" id="backToStep2">è¿”å›</button>
                <button class="btn btn--primary" id="proceedToStep4">ç”Ÿæˆé æ¸¬çµæœ</button>
            </div>
        </div>

        <!-- Step 4: Results -->
        <div class="section" id="step4" style="display: none;">
            <div class="section-header">
                <h2>æ­¥é©Ÿ 4: æ¯”è¼ƒé æ¸¬èˆ‡åˆ†æ</h2>
                <p>æŸ¥çœ‹ä¸åŒæƒ…å¢ƒçš„é æ¸¬çµæœ</p>
            </div>

            <div class="card">
                <div class="card__header">
                    <h3>é æ¸¬è¶¨å‹¢åœ–</h3>
                </div>
                <div class="card__body">
                    <div class="chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card__header">
                    <h3>é æ¸¬æ•¸æ“šè¡¨</h3>
                    <div class="chart-controls">
                        <button class="btn btn--sm btn--outline" id="exportCSVBtn">åŒ¯å‡º CSV</button>
                    </div>
                </div>
                <div class="card__body">
                    <div class="table-container">
                        <table class="data-table" id="forecastTable">
                            <thead>
                                <tr>
                                    <th>æœŸé–“</th>
                                    <th>åŸºç·š</th>
                                    <th>ä¿å®ˆå‹</th>
                                    <th>ç©©å¥å‹</th>
                                    <th>ç©æ¥µå‹</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn--outline" id="backToStep3">è¿”å›é…ç½®</button>
                <button class="btn btn--secondary" id="resetAllBtn">é‡æ–°é–‹å§‹</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         SINGLE SCRIPT BLOCK - NO DUPLICATES
         ======================================== -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
// ======================================
// 1. CONSTANTS & CONFIGURATION
// ======================================
const SAMPLE_DATA = {
  periods: ['Q1 2020', 'Q2 2020', 'Q3 2020', 'Q4 2020', 'Q1 2021', 'Q2 2021', 'Q3 2021', 'Q4 2021', 'Q1 2022', 'Q2 2022', 'Q3 2022', 'Q4 2022', 'Q1 2023', 'Q2 2023', 'Q3 2023', 'Q4 2023', 'Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024'],
  accounts: [28988, 75699, 170312, 323900, 475110, 684196, 992318, 1191417, 1331101, 1601099, 1690404, 1833495, 2024223, 1900206, 1995234, 2186658, 2186357, 2382030, 2270589, 2235095]
};

const state = {
  currentStep: 1,
  historicalData: [],
  dataQuality: null,
  fittedParams: null,
  forecastData: null,
  scenarioParams: {
    conservative: { alpha: 0.10, delta_t: 0.5, kappa: 0.02, half_life: 6, window_length: 6, expansion_length: 8 },
    moderate: { alpha: 0.20, delta_t: 1.0, kappa: 0.05, half_life: 8, window_length: 8, expansion_length: 10 },
    aggressive: { alpha: 0.35, delta_t: 1.5, kappa: 0.08, half_life: 10, window_length: 12, expansion_length: 12 }
  },
  platformLaunchQuarter: 3,
  interpolationMethod: 'ignore', // <-- æ–°å¢é€™ä¸€è¡Œ
};

let fittingChart = null;
let forecastChart = null;

// ======================================
// 2. UTILITY FUNCTIONS
// ======================================
function formatNumber(num) {
  if (!isFinite(num)) return 'N/A';
  if (num < 0) num = 0;
  return new Intl.NumberFormat('zh-TW').format(Math.round(num));
}

function parseQuarter(quarterStr) {
  const match = quarterStr.match(/Q(\d) (\d{4})/);
  if (!match) return null;
  return { quarter: parseInt(match[1]), year: parseInt(match[2]) };
}

function getNextQuarter(periodStr) {
  const parsed = parseQuarter(periodStr);
  if (!parsed) return null;
  let { quarter, year } = parsed;
  quarter++;
  if (quarter > 4) {
    quarter = 1;
    year++;
  }
  return `Q${quarter} ${year}`;
}

function generateQuarters(startQuarter, numQuarters) {
  const parsed = parseQuarter(startQuarter);
  if (!parsed) return [];
  
  const quarters = [];
  let { quarter, year } = parsed;
  
  for (let i = 0; i < numQuarters; i++) {
    quarters.push(`Q${quarter} ${year}`);
    quarter++;
    if (quarter > 4) {
      quarter = 1;
      year++;
    }
  }
  return quarters;
}

function showToast(message, duration = 3000) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transition = 'opacity 0.3s';
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

// ======================================
// 3. GOMPERTZ MODEL FUNCTIONS
// ======================================
function gompertzModel(t, K, b, t0) {
  if (!isFinite(K) || !isFinite(b) || !isFinite(t0) || K <= 0 || b <= 0) {
    return NaN;
  }
  
  let exponent = -b * (t - t0);
  exponent = Math.max(-700, Math.min(700, exponent));
  
  let inner_exp = Math.exp(exponent);
  if (!isFinite(inner_exp)) return NaN;
  
  let outer_exp = -inner_exp;
  outer_exp = Math.max(-700, Math.min(700, outer_exp));
  
  let result = K * Math.exp(outer_exp);
  return isFinite(result) ? result : NaN;
}

function calculateR2(data, params) {
  const n = data.length;
  if (n === 0) return 0;
  
  const mean = data.reduce((sum, val) => sum + val, 0) / n;
  let ssRes = 0, ssTot = 0;
  
  for (let i = 0; i < n; i++) {
    const predicted = gompertzModel(i, params.K, params.b, params.t0);
    if (isFinite(predicted)) {
      ssRes += Math.pow(data[i] - predicted, 2);
    } else {
      ssRes += Math.pow(data[i] - mean, 2); // æ‡²ç½°ç„¡æ•ˆçš„é æ¸¬
    }
    ssTot += Math.pow(data[i] - mean, 2);
  }
  
  if (ssTot === 0) return 1; // æ‰€æœ‰æ•¸æ“šé»éƒ½ç›¸åŒ
  const r2 = 1 - (ssRes / ssTot);
  return isFinite(r2) ? Math.max(0, Math.min(1, r2)) : 0;
}

function fitGompertzCurve(data) {
  const n = data.length;
  const maxAccounts = Math.max(...data);
  
  let bestParams = null;
  let bestError = Infinity;
  
  const K_steps = [1.1, 1.3, 1.5, 2.0, 2.5];
  const b_steps = [0.05, 0.1, 0.15, 0.2, 0.3, 0.4];
  const t0_steps = [-2, 0, n * 0.3, n * 0.5, n * 0.7, n + 2];
  
  for (const k_mult of K_steps) {
    const K = maxAccounts * k_mult;
    if (K <= maxAccounts) continue;
    
    for (const b of b_steps) {
      if (b <= 0 || b > 1.0) continue;
      
      for (const t0 of t0_steps) {
        let error = 0;
        let hasNaN = false;
        
        for (let i = 0; i < n; i++) {
          const predicted = gompertzModel(i, K, b, t0);
          if (!isFinite(predicted)) {
            hasNaN = true;
            break;
          }
          error += Math.pow(data[i] - predicted, 2);
        }
        
        if (!hasNaN && isFinite(error) && error < bestError) {
          bestError = error;
          bestParams = { K, b, t0 };
        }
      }
    }
  }
  
  if (!bestParams) {
    bestParams = { K: maxAccounts * 1.5, b: 0.2, t0: n * 0.5 };
  }
  
  const mean = data.reduce((sum, val) => sum + val, 0) / n;
  let ssRes = 0, ssTot = 0;
  
  for (let i = 0; i < n; i++) {
    const predicted = gompertzModel(i, bestParams.K, bestParams.b, bestParams.t0);
    if (isFinite(predicted)) {
      ssRes += Math.pow(data[i] - predicted, 2);
    }
    ssTot += Math.pow(data[i] - mean, 2);
  }
  
  const r2 = ssTot > 0 ? Math.max(0, Math.min(1, 1 - (ssRes / ssTot))) : 0;
  const rmse = Math.sqrt(ssRes / n);
  
  return {
    params: bestParams,
    r2: isFinite(r2) ? r2 : 0,
    rmse: isFinite(rmse) ? rmse : Infinity,
    valid: isFinite(r2)
  };
} // fitGompertzCurve çµæŸçš„ }

// --- æ–°å¢ï¼šå›ºå®š K ä¸¦é‡æ–°æ“¬åˆ b, t0 ---
function refitWithFixedK(fixedK) {
  const validData = state.historicalData.filter(d => !d.isMissing);
  const data = validData.map(d => d.accounts);
  const n = data.length;
  
  if (!isFinite(fixedK) || fixedK <= Math.max(...data)) {
    alert(`K (æ‰¿è¼‰å®¹é‡) å¿…é ˆå¤§æ–¼æ­·å²æœ€å¤§å€¼ (${formatNumber(Math.max(...data))})ã€‚`);
    return null;
  }

  let bestParams = null;
  let bestError = Infinity;
  
  // ç§»é™¤ K è¿´åœˆï¼Œåªæœå°‹ b å’Œ t0
  const b_steps = [0.05, 0.1, 0.15, 0.2, 0.3, 0.4, 0.5];
  const t0_steps = [-5, -2, 0, n * 0.3, n * 0.5, n * 0.7, n + 2, n + 5];
  
  for (const b of b_steps) {
    if (b <= 0 || b > 2.0) continue;
    
    for (const t0 of t0_steps) {
      let error = 0;
      let hasNaN = false;
      
      for (let i = 0; i < n; i++) {
        const predicted = gompertzModel(i, fixedK, b, t0);
        if (!isFinite(predicted)) {
          hasNaN = true;
          break;
        }
        error += Math.pow(data[i] - predicted, 2);
      }
      
      if (!hasNaN && isFinite(error) && error < bestError) {
        bestError = error;
        bestParams = { K: fixedK, b, t0 };
      }
    }
  }

  if (!bestParams) {
    alert('é‡æ–°æ“¬åˆå¤±æ•—ã€‚è«‹å˜—è©¦èª¿æ•´ K å€¼ã€‚');
    return null;
  }
  
  // è¨ˆç®— RÂ²
  const r2 = calculateR2(data, bestParams);
  
  return { params: bestParams, r2 };
}

function applyIntervention(t, baselineValue, params, interventionParams, launchQuarter) {
  if (!isFinite(t) || !isFinite(baselineValue)) return baselineValue;
  if (t < launchQuarter) return baselineValue;

  const { K, b, t0 } = params;
  // å¾ state è®€å–å®Œæ•´çš„åƒæ•¸ (æ³¨æ„ï¼šæˆ‘å€‘åªç”¨é€™å››å€‹)
  const { alpha, delta_t, kappa, half_life } = interventionParams;
  const tSinceLaunch = t - launchQuarter;
  
  // --- 1. æˆé•·ç‡åŠ é€Ÿ (b) ---
  const decayExponent = -Math.log(2) * tSinceLaunch / half_life;
  const clampedExp = Math.max(-100, Math.min(0, decayExponent));
  const decayFactor = Math.exp(clampedExp);
  const cappedAlpha = Math.min(0.5, Math.max(0, alpha));
  const accelerationFactor = 1 + cappedAlpha * decayFactor;
  
  // --- 2. ä¸Šé™æ“´å¼µ (K) ---
  // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ä½¿ç”¨èˆ‡ b ç›¸åŒçš„è¡°æ¸›å‡½æ•¸ä¾†å¹³æ»‘éæ¸¡ K
  // é€™æ¨£ K æœƒå¹³æ»‘åœ°å¾ K å¢é•·åˆ° K * (1 + kappa)
  const cappedKappa = Math.min(0.2, Math.max(0, kappa));
  const expansionSmoother = 1 - decayFactor; // ç•¶ t å¾ˆå¤§æ™‚ï¼ŒdecayFactor -> 0, smoother -> 1
  const capacityFactor = 1 + cappedKappa * expansionSmoother;
  
  // --- 3. æ‹é»å‰ç§» (t0) ---
  const cappedDeltaT = Math.min(5, Math.max(0, delta_t));
  const shiftSmoother = 1 - decayFactor; // åŒä¸Šï¼Œå¹³æ»‘åœ°å‰ç§»
  const adjustedT0_shift = cappedDeltaT * shiftSmoother;
  
  // --- çµ„åˆåƒæ•¸ ---
  const adjustedK = K * capacityFactor;
  const adjustedB = b * accelerationFactor;
  const adjustedT0 = t0 - adjustedT0_shift;

  const result = gompertzModel(t, adjustedK, adjustedB, adjustedT0);
  
  // ç¢ºä¿ä»‹å…¥çµæœä¸æœƒä½æ–¼åŸºç·š
  return isFinite(result) ? Math.max(baselineValue, result) : baselineValue;
}

// ======================================
// 4. NAVIGATION & STEP CONTROL
// ======================================
function goToStep(step) {
  for (let i = 1; i <= 4; i++) {
    document.getElementById(`step${i}`).style.display = 'none';
    const stepEl = document.querySelector(`.step[data-step="${i}"]`);
    stepEl.classList.remove('active', 'completed');
    if (i < step) stepEl.classList.add('completed');
  }
  
  document.getElementById(`step${step}`).style.display = 'block';
  document.querySelector(`.step[data-step="${step}"]`).classList.add('active');
  state.currentStep = step;
}

// ======================================
// 5. DATA INPUT & VALIDATION
// ======================================
function loadSampleData() {
  const dataText = SAMPLE_DATA.periods.map((period, i) => {
    return `${period},${SAMPLE_DATA.accounts[i]}`;
  }).join('\n');
  
  document.getElementById('dataInput').value = dataText;
  parseAndDisplayData();
}

function parseAndDisplayData() {
  const dataInput = document.getElementById('dataInput').value;
  const lines = dataInput.trim().split('\n');
  const data = [];
  const errorEl = document.getElementById('dataError');
  
  try {
    for (const line of lines) {
      if (!line.trim()) continue;
      
      const parts = line.split(',');
      if (parts.length !== 2) {
        throw new Error('æ¯è¡Œå¿…é ˆåŒ…å«å…©å€‹å€¼: æœŸé–“,å¸³æˆ¶æ•¸');
      }
      
      const period = parts[0].trim();
      const accountsStr = parts[1].trim();
      
      let accounts = null;
      let isMissing = false;
      
      // è™•ç† 'x', 'X', 'na' ç­‰ç„¡æ•ˆå€¼
      if (accountsStr === '' || accountsStr === '-' || accountsStr.toLowerCase() === 'null' || accountsStr.toLowerCase() === 'na' || accountsStr.toLowerCase() === 'x') {
        isMissing = true;
      } else {
        accounts = parseFloat(accountsStr);
        if (isNaN(accounts)) {
          accounts = null;
          isMissing = true;
        } else if (accounts < 0) {
          throw new Error(`å¸³æˆ¶æ•¸ä¸èƒ½ç‚ºè² æ•¸: ${accountsStr}`);
        }
      }
      
      data.push({ period, accounts, isMissing, dataType: isMissing ? 'Missing' : 'Original' });
    }
    
    // --- æ–°å¢ï¼šå¡«è£œæ™‚é–“é–“éš™ ---
    if (data.length < 2) {
      if (data.length === 0) throw new Error('è«‹è¼¸å…¥æ•¸æ“š');
      state.historicalData = data; 
    } else {
      const filledData = [];
      const dataMap = new Map(data.map(d => [d.period, d]));
      
      let currentPeriod = data[0].period;
      const lastPeriod = data[data.length - 1].period;
      
      filledData.push(data[0]); 
      
      let safetyBreak = 0; 
      while (currentPeriod !== lastPeriod && safetyBreak < 200) {
          const nextPeriod = getNextQuarter(currentPeriod);
          if (!nextPeriod) {
            console.error('ç„¡æ³•å¾ ' + currentPeriod + ' è§£æä¸‹ä¸€å€‹å­£åº¦');
            break; 
          }
          
          if (dataMap.has(nextPeriod)) {
              filledData.push(dataMap.get(nextPeriod));
          } else {
              // æ‰¾åˆ°é–“éš™ï¼è£œä¸Šç¼ºæ¼å€¼
              filledData.push({
                  period: nextPeriod,
                  accounts: null,
                  isMissing: true,
                  dataType: 'Missing (Gap)'
              });
          }
          currentPeriod = nextPeriod;
          safetyBreak++;
      }
      state.historicalData = filledData;
    }
    // --- çµæŸï¼šå¡«è£œæ™‚é–“é–“éš™ ---

    if (state.historicalData.length < 8) {
      throw new Error('ç¸½æ•¸æ“šé»ï¼ˆåŒ…å«å¡«è£œçš„é–“éš™ï¼‰å°‘æ–¼ 8 å€‹');
    }
    
    analyzeDataQuality();
    displayDataQualityReport();
    displayDataPreview(state.historicalData); // æ”¹ç‚ºä½¿ç”¨ state.historicalData
    errorEl.style.display = 'none';
    
  } catch (error) {
    errorEl.textContent = `éŒ¯èª¤: ${error.message}`;
    errorEl.style.display = 'block';
  }
}

function analyzeDataQuality() {
  const data = state.historicalData;
  const issues = [];
  let score = 100;

  // çœŸæ­£è¨ˆç®—ç¼ºæ¼å€¼
  const missingCount = data.filter(d => d.isMissing).length;
  const validCount = data.length - missingCount;

  if (missingCount === 0) {
    issues.push({
      type: 'success',
      icon: 'âœ“',
      title: 'æ•¸æ“šå®Œæ•´æ€§: å„ªç•°',
      description: `æ‰€æœ‰ ${data.length} å€‹å­£åº¦çš„æ•¸æ“šéƒ½å­˜åœ¨`
    });
  } else {
    issues.push({
      type: 'warning',
      icon: 'âš ï¸',
      title: `æ•¸æ“šç¼ºæ¼: ${missingCount} å€‹å­£åº¦ç¼ºæ¼`,
      description: 'æª¢æ¸¬åˆ°æ™‚é–“é–“éš™æˆ–ç„¡æ•ˆæ•¸æ“šã€‚ç¼ºæ¼æ•¸æ“šå·²åœ¨é è¦½è¡¨ä¸­æ¨™è¨˜ã€‚'
    });
    score -= missingCount * 5; // æ¯å€‹ç¼ºæ¼æ‰£ 5 åˆ†
  }
  
  if (validCount < 8) {
    issues.push({
      type: 'error',
      icon: 'âŒ',
      title: 'æœ‰æ•ˆæ•¸æ“šé»ä¸è¶³',
      description: `åƒ…æœ‰ ${validCount} å€‹æœ‰æ•ˆæ•¸æ“šé»ï¼Œè‡³å°‘éœ€è¦ 8 å€‹æ‰èƒ½å¯é æ“¬åˆã€‚`
    });
    score -= 50; // åš´é‡æ‰£åˆ†
  }

  score = Math.max(0, Math.min(100, score));
  state.dataQuality = { score, issues, validCount, totalCount: data.length, missingCount };
}

function displayDataQualityReport() {
  const card = document.getElementById('dataQualityCard');
  const quality = state.dataQuality;
  
  const scoreFill = document.getElementById('qualityScoreFill');
  const scoreValue = document.getElementById('qualityScoreValue');
  
  scoreFill.style.width = quality.score + '%';
  scoreValue.textContent = quality.score + '/100';
  
  // æ ¹æ“šåˆ†æ•¸æ”¹è®Šé¡è‰²å’Œåœ–ç¤º
  if (quality.score < 100) {
    scoreFill.style.background = 'var(--color-warning)'; // è®Šç‚ºè­¦å‘Šè‰²
    scoreValue.textContent = 'âš ï¸ ' + quality.score + '/100';
  } else {
    scoreFill.style.background = 'var(--color-success)';
    scoreValue.textContent = 'âœ“ ' + quality.score + '/100';
  }
  
  const issuesContainer = document.getElementById('qualityIssues');
  issuesContainer.innerHTML = quality.issues.map(issue => `
    <div style="padding: var(--space-8); margin-bottom: var(--space-8); background: ${issue.type === 'success' ? 'var(--color-bg-3)' : 'var(--color-bg-2)'}; border-radius: var(--radius-base);">
      <div style="font-weight: var(--font-weight-semibold);">${issue.icon} ${issue.title}</div>
      <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">${issue.description}</div>
    </div>
  `).join('');
  
  card.style.display = 'block';

  // --- æ–°å¢ï¼šé¡¯ç¤º/éš±è—æ’å€¼å¡ç‰‡ ---
  if (quality.missingCount > 0) {
    document.getElementById('missingDataCard').style.display = 'block';
    document.getElementById('bestPracticesCard').style.display = 'block';
  } else {
    document.getElementById('missingDataCard').style.display = 'none';
    document.getElementById('bestPracticesCard').style.display = 'none';
  }
  // --- æ–°å¢çµæŸ ---
}

function displayDataPreview(data) {
  const tbody = document.querySelector('#dataPreviewTable tbody');
  tbody.innerHTML = '';
  
  data.forEach((row, index) => {
    const tr = document.createElement('tr');
    
    // Determine row status
    let statusClass = 'status-valid';
    let statusBadge = '<span class="status-badge valid">âœ“ æ­£å¸¸</span>';
    let outlierBadge = '-';
    let recommendation = 'ç„¡éœ€è™•ç†';
    let actions = '-';
    
    if (row.isMissing) {
      statusClass = 'status-missing';
      statusBadge = '<span class="status-badge missing">âš ï¸ ç¼ºæ¼</span>';
      recommendation = 'å»ºè­°æ’å€¼';
      actions = '<button class="btn btn--sm btn--outline" onclick="editCell(' + index + ')">æ‰‹å‹•è¼¸å…¥</button>';
    } else if (row.dataType === 'Interpolated') {
      statusClass = 'status-interpolated';
      statusBadge = '<span class="status-badge interpolated">ğŸ“Š å·²æ’å€¼</span>';
      recommendation = 'å·²è™•ç†';
      actions = '<button class="btn btn--sm btn--outline" onclick="editCell(' + index + ')">ä¿®æ”¹</button>';
    } else if (row.isOutlier) {
      statusClass = 'status-outlier';
      outlierBadge = '<span class="status-badge outlier">âš ï¸ ç•°å¸¸</span>';
      recommendation = 'è«‹ç¢ºèªæ•¸æ“š';
      actions = '<button class="btn btn--sm btn--outline" onclick="confirmCell(' + index + ')">ç¢ºèªç„¡èª¤</button>';
    }
    
    const valueDisplay = row.isMissing ? '<em style="color: var(--color-text-secondary);">ç¼ºæ¼</em>' : formatNumber(row.accounts);
    
    tr.className = statusClass;
    tr.innerHTML = `
      <td>${row.period}</td>
      <td>${valueDisplay}</td>
      <td>${statusBadge}</td>
      <td>${outlierBadge}</td>
      <td style="font-size: var(--font-size-sm);">${recommendation}</td>
      <td class="cell-actions">${actions}</td>
    `;
    tbody.appendChild(tr);
  });
  
  document.getElementById('dataPreviewCard').style.display = 'block';
}

// Cell editing functions
function editCell(index) {
  const value = prompt('è«‹è¼¸å…¥å¸³æˆ¶æ•¸:', state.historicalData[index].accounts || '');
  if (value !== null) {
    const accounts = parseFloat(value);
    if (!isNaN(accounts) && accounts >= 0) {
      state.historicalData[index].accounts = accounts;
      state.historicalData[index].isMissing = false;
      state.historicalData[index].dataType = 'Corrected';
      analyzeDataQuality();
      displayDataQualityReport();
      displayDataPreview(state.historicalData);
    } else {
      alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—');
    }
  }
}

function confirmCell(index) {
  state.historicalData[index].isOutlier = false;
  state.historicalData[index].dataType = 'Confirmed';
  analyzeDataQuality();
  displayDataQualityReport();
  displayDataPreview(state.historicalData);
}

function validateAndProceed() {
  if (state.historicalData.length === 0) {
    alert('è«‹å…ˆè¼¸å…¥æˆ–è¼‰å…¥æ•¸æ“š');
    return;
  }
  
  // --- æ–°å¢ï¼šæ’å€¼æª¢æŸ¥ ---
  if (!state.dataQuality) {
    analyzeDataQuality();
  }
  
  const stillMissing = state.historicalData.filter(d => d.isMissing).length;
  if (stillMissing > 0) {
    if (state.interpolationMethod === 'ignore' || !state.interpolationMethod) {
      if (!confirm(`ä»æœ‰ ${stillMissing} å€‹ç¼ºæ¼å€¼æœªè™•ç†ã€‚å°‡åœ¨æ“¬åˆæ™‚å¿½ç•¥é€™äº›é»ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ`)) {
        return;
      }
    }
  }
  // --- æ–°å¢çµæŸ ---
  
  goToStep(2);
  performFitting();
}

// ======================================
// 6. MODEL FITTING
// ======================================
function performFitting() {
  const statusEl = document.getElementById('fittingStatus');
  const paramsEl = document.getElementById('parametersDisplay');
  
  statusEl.textContent = 'æ­£åœ¨æ“¬åˆæ¨¡å‹...';
  paramsEl.style.display = 'none';
  
  setTimeout(() => {
    // --- ä¿®æ­£ï¼šåœ¨æ“¬åˆå‰éæ¿¾æ‰ç¼ºæ¼çš„æ•¸æ“š ---
    const validData = state.historicalData.filter(d => !d.isMissing);
    const accounts = validData.map(d => d.accounts);
    
    if (accounts.length < 8) {
        statusEl.textContent = 'âœ˜ æ“¬åˆå¤±æ•—ï¼šæœ‰æ•ˆæ•¸æ“šé»ä¸è¶³ (å°‘æ–¼ 8 å€‹)';
        statusEl.style.color = 'var(--color-error)';
        return;
    }
    // --- ä¿®æ­£çµæŸ ---
    
    const result = fitGompertzCurve(accounts);
    
    if (!result) {
      statusEl.textContent = 'âœ˜ æ“¬åˆå¤±æ•—';
      statusEl.style.color = 'var(--color-error)';
      return;
    }
    
    state.fittedParams = result.params;
    
    // --- ä¿®æ”¹ï¼šå°‡å€¼å¡«å…¥ input è€Œä¸æ˜¯ textContent ---
    document.getElementById('inputParamK').value = Math.round(result.params.K);
    document.getElementById('inputParamB').value = result.params.b.toFixed(4);
    document.getElementById('inputParamT0').value = result.params.t0.toFixed(2);
    // --- ä¿®æ”¹çµæŸ ---
    
    if (result.r2 > 0.95) {
      statusEl.innerHTML = 'âœ” æ“¬åˆæˆåŠŸï¼RÂ² = ' + result.r2.toFixed(4) + ' (å„ªç•°)';
      statusEl.style.color = 'var(--color-success)';
    } else {
      statusEl.innerHTML = 'âš ï¸ æ“¬åˆå®Œæˆï¼ŒRÂ² = ' + result.r2.toFixed(4);
      statusEl.style.color = 'var(--color-warning)';
    }
    
    paramsEl.style.display = 'block';
    displayFittingChart();
  }, 500);
}

function displayFittingChart() {
  const ctx = document.getElementById('fittingChart').getContext('2d');
  
  const periods = state.historicalData.map(d => d.period);
  const actual = state.historicalData.map(d => d.accounts);
  const fitted = state.historicalData.map((d, i) => 
    gompertzModel(i, state.fittedParams.K, state.fittedParams.b, state.fittedParams.t0)
  );
  
  if (fittingChart) fittingChart.destroy();
  
  fittingChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: periods,
      datasets: [
        {
          label: 'å¯¦éš›æ•¸æ“š',
          data: actual,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          pointRadius: 5,
          borderWidth: 2
        },
        {
          label: 'æ“¬åˆæ›²ç·š',
          data: fitted,
          borderColor: '#10b981',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [5, 5],
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'top' },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatNumber(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: function(value) { return formatNumber(value); } }
        }
      }
    }
    });
  } // displayFittingChart çµæŸçš„ }

  // --- æ–°å¢ï¼šæ‰‹å‹•æ›´æ–°åƒæ•¸æ™‚è§¸ç™¼ ---
  function updateManualParamsAndChart() {
    try {
      const newK = parseFloat(document.getElementById('inputParamK').value);
      const newB = parseFloat(document.getElementById('inputParamB').value);
      const newT0 = parseFloat(document.getElementById('inputParamT0').value);

      if (!isFinite(newK) || !isFinite(newB) || !isFinite(newT0)) {
        return; // å¦‚æœè¼¸å…¥ç„¡æ•ˆ (ä¾‹å¦‚ç©ºçš„)ï¼Œå‰‡ä¸æ›´æ–°
      }
      
      // åƒ…æ›´æ–° state å’Œåœ–è¡¨
      state.fittedParams.K = newK;
      state.fittedParams.b = newB;
      state.fittedParams.t0 = newT0;
      displayFittingChart();
      
    } catch (e) {
      console.error("Error updating manual params:", e);
    }
  }

// ======================================
// 6.5. INTERPOLATION FUNCTIONS (æ–°å¢)
// ======================================
function applyInterpolation() {
  const method = document.querySelector('input[name="interpolation"]:checked').value;
  state.interpolationMethod = method;
  
  const data = state.historicalData;
  const missingIndices = data.map((d, i) => d.isMissing ? i : -1).filter(i => i >= 0);
  
  if (missingIndices.length === 0) {
    alert('æ²’æœ‰éœ€è¦æ’å€¼çš„æ•¸æ“š');
    return;
  }
  
  if (method === 'ignore') {
    alert('å°‡åœ¨æ“¬åˆæ™‚å¿½ç•¥ç¼ºæ¼æ•¸æ“šé»');
    // éœ€è¦é‡ç½®å¯èƒ½å·²æ’å€¼çš„æ•¸æ“š
    data.forEach(d => {
        if (d.dataType === 'Interpolated') {
            d.isMissing = true;
            d.accounts = null;
            d.dataType = 'Missing (Gap)';
        }
    });
  } else {
    // Apply interpolation based on method
    missingIndices.forEach(i => {
      let interpolatedValue = null;
      
      if (method === 'linear') {
        interpolatedValue = linearInterpolation(data, i);
      } else if (method === 'gompertz') {
        interpolatedValue = gompertzInterpolation(data, i);
      } else if (method === 'forward') {
        interpolatedValue = forwardFill(data, i);
      }
      
      if (interpolatedValue !== null && isFinite(interpolatedValue)) {
        data[i].accounts = interpolatedValue;
        data[i].isMissing = false;
        data[i].dataType = 'Interpolated';
      }
    });
  }
  
  // é¡¯ç¤ºæ’å€¼å½±éŸ¿
  const oldScore = state.dataQuality ? state.dataQuality.score : 0;
  
  // Recalculate quality after interpolation
  analyzeDataQuality();
  displayDataQualityReport();
  displayDataPreview(data);
  
  const newScore = state.dataQuality.score;
  const improvement = newScore - oldScore;
  const methodMap = getMethodName(method);
  
  const impactDiv = document.getElementById('interpolationImpact');
  if (method === 'ignore') {
    impactDiv.innerHTML = `
      <h4>âœ“ å·²é‡ç½®</h4>
      <p>å·²å°‡ ${missingIndices.length} å€‹ç¼ºæ¼å€¼æ¨™è¨˜ç‚º "å¿½ç•¥"ã€‚</p>
      <p>æ•¸æ“šå“è³ªåˆ†æ•¸: <strong>${newScore}/100</strong></p>
    `;
  } else {
    impactDiv.innerHTML = `
      <h4>âœ“ æ’å€¼å®Œæˆ</h4>
      <p>å·²ä½¿ç”¨ <strong>${methodMap}</strong> å¡«è£œ ${missingIndices.length} å€‹ç¼ºæ¼å€¼ã€‚</p>
      <p>æ•¸æ“šå“è³ªåˆ†æ•¸: <strong>${oldScore}/100</strong> â†’ <strong style="color: var(--color-success);">${newScore}/100</strong> ${improvement > 0 ? '(+' + improvement.toFixed(0) + ')' : ''}</p>
    `;
  }
  impactDiv.style.display = 'block';
}

function getMethodName(method) {
  const names = {
    'linear': 'ç·šæ€§æ’å€¼',
    'gompertz': 'Gompertz æ’å€¼',
    'forward': 'å‘å‰å¡«å……',
    'ignore': 'å¿½ç•¥'
  };
  return names[method] || method;
}

function linearInterpolation(data, index) {
  // Find previous and next valid values
  let prevIndex = -1, nextIndex = -1;
  
  for (let i = index - 1; i >= 0; i--) {
    if (data[i].accounts !== null && !data[i].isMissing) {
      prevIndex = i;
      break;
    }
  }
  
  for (let i = index + 1; i < data.length; i++) {
    if (data[i].accounts !== null && !data[i].isMissing) {
      nextIndex = i;
      break;
    }
  }
  
  if (prevIndex >= 0 && nextIndex >= 0) {
    const prevValue = data[prevIndex].accounts;
    const nextValue = data[nextIndex].accounts;
    const gap = nextIndex - prevIndex;
    const position = index - prevIndex;
    return prevValue + (nextValue - prevValue) * (position / gap);
  } else if (prevIndex >= 0) {
    return data[prevIndex].accounts; // å‘å‰å¡«å……
  } else if (nextIndex >= 0) {
    return data[nextIndex].accounts; // å‘å¾Œå¡«å……
  }
  
  return null;
}

function gompertzInterpolation(data, index) {
  // Fit preliminary Gompertz to non-missing data
  const validData = data.filter(d => !d.isMissing).map(d => d.accounts);
  
  if (validData.length < 8) {
    // Fall back to linear if not enough data
    return linearInterpolation(data, index);
  }
  
  const result = fitGompertzCurve(validData);
  if (!result || !result.valid) {
    return linearInterpolation(data, index);
  }
  
  // Evaluate at missing index
  const value = gompertzModel(index, result.params.K, result.params.b, result.params.t0);
  return isFinite(value) ? value : linearInterpolation(data, index);
}

function forwardFill(data, index) {
  // Find previous valid value
  for (let i = index - 1; i >= 0; i--) {
    if (data[i].accounts !== null && !data[i].isMissing) {
      return data[i].accounts;
    }
  }
  
  // If no previous, find next
  for (let i = index + 1; i < data.length; i++) {
    if (data[i].accounts !== null && !data[i].isMissing) {
      return data[i].accounts;
    }
  }
  
  return null;
}

// ======================================
// 7. SCENARIO CONFIGURATION (é€™æ˜¯ä¸‹ä¸€å€‹å€å¡Šçš„é–‹é ­)

// ======================================
// 7. SCENARIO CONFIGURATION
// ======================================
function initializeSliders() {
  const scenarios = ['conservative', 'moderate', 'aggressive'];
  // æ–°å¢ delta_t å’Œ kappa
  const params = ['alpha', 'half_life', 'delta_t', 'kappa'];
  
  scenarios.forEach(scenario => {
    params.forEach(param => {
      const sliderId = `${param}_${scenario}`;
      const slider = document.getElementById(sliderId);
      const valueEl = document.getElementById(`${sliderId}_val`);
      
      if (slider && valueEl) {
        slider.addEventListener('input', (e) => {
          let value = parseFloat(e.target.value);
          let displayValue = value;
          
          if (param === 'alpha' || param === 'kappa') {
            valueEl.textContent = value; // é¡¯ç¤º 10, 2
            value = value / 100; // å„²å­˜ 0.1, 0.02
          } else {
            valueEl.textContent = value; // é¡¯ç¤º 6, 0.5
          }
          
          state.scenarioParams[scenario][param] = value;
        });
      }
    });
  });
}

function loadScenarioPreset(scenario) {
  const presets = {
    conservative: { alpha: 0.10, delta_t: 0.5, kappa: 0.02, half_life: 6 },
    moderate: { alpha: 0.20, delta_t: 1.0, kappa: 0.05, half_life: 8 },
    aggressive: { alpha: 0.35, delta_t: 1.5, kappa: 0.08, half_life: 10 }
  };
  
  const preset = presets[scenario];
  // æ›´æ–° state (æˆ‘å€‘åªæ›´æ–°é€™å››å€‹)
  state.scenarioParams[scenario] = { 
    alpha: preset.alpha, 
    half_life: preset.half_life, 
    delta_t: preset.delta_t, 
    kappa: preset.kappa 
  };
  
  // æ›´æ–°æ‰€æœ‰å››å€‹æ»‘æ¡¿çš„å€¼
  document.getElementById(`alpha_${scenario}`).value = preset.alpha * 100;
  document.getElementById(`alpha_${scenario}_val`).textContent = (preset.alpha * 100);
  
  document.getElementById(`half_life_${scenario}`).value = preset.half_life;
  document.getElementById(`half_life_${scenario}_val`).textContent = preset.half_life;
  
  document.getElementById(`delta_t_${scenario}`).value = preset.delta_t;
  document.getElementById(`delta_t_${scenario}_val`).textContent = preset.delta_t;
  
  document.getElementById(`kappa_${scenario}`).value = preset.kappa * 100;
  document.getElementById(`kappa_${scenario}_val`).textContent = (preset.kappa * 100);
  
  showToast(`âœ“ å·²è¼‰å…¥${scenario === 'conservative' ? 'ä¿å®ˆå‹' : scenario === 'moderate' ? 'ç©©å¥å‹' : 'ç©æ¥µå‹'}æƒ…å¢ƒé è¨­`);
}

// ======================================
// 8. FORECAST GENERATION & DISPLAY
// ======================================
function generateForecasts() {
  const forecastYears = parseInt(document.getElementById('forecastYears').value);
  const forecastQuarters = forecastYears * 4;
  let platformLaunch = parseInt(document.getElementById('platformLaunch').value);
  
  if (!platformLaunch || platformLaunch < 1) {
    platformLaunch = 3;
    document.getElementById('platformLaunch').value = 3;
  }
  
  state.platformLaunchQuarter = platformLaunch;
  
  const lastPeriod = state.historicalData[state.historicalData.length - 1].period;
  const forecastPeriods = generateQuarters(lastPeriod, forecastQuarters + 1).slice(1);
  const baseOffset = state.historicalData.length;
  
  const forecasts = {
    periods: forecastPeriods,
    baseline: [],
    conservative: [],
    moderate: [],
    aggressive: []
  };
  
  for (let i = 0; i < forecastQuarters; i++) {
    const t = baseOffset + i;
    const baseline = gompertzModel(t, state.fittedParams.K, state.fittedParams.b, state.fittedParams.t0);
    
    forecasts.baseline.push(baseline);
    forecasts.conservative.push(applyIntervention(t, baseline, state.fittedParams, state.scenarioParams.conservative, baseOffset + platformLaunch));
    forecasts.moderate.push(applyIntervention(t, baseline, state.fittedParams, state.scenarioParams.moderate, baseOffset + platformLaunch));
    forecasts.aggressive.push(applyIntervention(t, baseline, state.fittedParams, state.scenarioParams.aggressive, baseOffset + platformLaunch));
  }
  
  state.forecastData = forecasts;
  
  goToStep(4);
  displayForecastChart();
  displayForecastTable();
}

function displayForecastChart() {
  const ctx = document.getElementById('forecastChart').getContext('2d');
  
  if (forecastChart) forecastChart.destroy();
  
  const filterNaN = (arr) => arr.map(v => isFinite(v) ? v : null);
  
  forecastChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: state.forecastData.periods,
      datasets: [
        {
          label: 'åŸºç·š',
          data: filterNaN(state.forecastData.baseline),
          borderColor: '#6b7280',
          backgroundColor: 'transparent',
          borderWidth: 3,
          pointRadius: 0
        },
        {
          label: 'ä¿å®ˆå‹',
          data: filterNaN(state.forecastData.conservative),
          borderColor: '#3b82f6',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [5, 3],
          pointRadius: 0
        },
        {
          label: 'ç©©å¥å‹',
          data: filterNaN(state.forecastData.moderate),
          borderColor: '#10b981',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [5, 3],
          pointRadius: 0
        },
        {
          label: 'ç©æ¥µå‹',
          data: filterNaN(state.forecastData.aggressive),
          borderColor: '#ef4444',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [5, 3],
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'top' },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed.y;
              if (value === null || !isFinite(value)) return context.dataset.label + ': N/A';
              return context.dataset.label + ': ' + formatNumber(value);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          ticks: { callback: function(value) { return formatNumber(value); } }
        }
      }
    }
  });
}

function displayForecastTable() {
  const tbody = document.querySelector('#forecastTable tbody');
  tbody.innerHTML = '';
  
  const n = state.forecastData.periods.length;
  
  for (let i = 0; i < n; i++) {
    const tr = document.createElement('tr');
    
    const baseline = state.forecastData.baseline[i];
    const conservative = state.forecastData.conservative[i];
    const moderate = state.forecastData.moderate[i];
    const aggressive = state.forecastData.aggressive[i];
    
    const formatSafe = (val) => isFinite(val) ? formatNumber(val) : 'N/A';
    
    tr.innerHTML = `
      <td>${state.forecastData.periods[i]}</td>
      <td>${formatSafe(baseline)}</td>
      <td>${formatSafe(conservative)}</td>
      <td>${formatSafe(moderate)}</td>
      <td>${formatSafe(aggressive)}</td>
    `;
    
    tbody.appendChild(tr);
  }
}

function exportCSV() {
  let csv = 'æœŸé–“,åŸºç·š,ä¿å®ˆå‹,ç©©å¥å‹,ç©æ¥µå‹\n';
  
  const n = state.forecastData.periods.length;
  for (let i = 0; i < n; i++) {
    const baseline = state.forecastData.baseline[i];
    const conservative = state.forecastData.conservative[i];
    const moderate = state.forecastData.moderate[i];
    const aggressive = state.forecastData.aggressive[i];
    
    const baselineStr = isFinite(baseline) ? baseline.toFixed(0) : 'N/A';
    const conservativeStr = isFinite(conservative) ? conservative.toFixed(0) : 'N/A';
    const moderateStr = isFinite(moderate) ? moderate.toFixed(0) : 'N/A';
    const aggressiveStr = isFinite(aggressive) ? aggressive.toFixed(0) : 'N/A';
    
    csv += `${state.forecastData.periods[i]},${baselineStr},${conservativeStr},${moderateStr},${aggressiveStr}\n`;
  }
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'forecast_data.csv';
  a.click();
  window.URL.revokeObjectURL(url);
}

// ======================================
// 9. EVENT LISTENERS & INITIALIZATION
// ======================================
document.addEventListener('DOMContentLoaded', () => {
  loadSampleData();
  
  document.getElementById('loadSampleBtn').addEventListener('click', loadSampleData);
  document.getElementById('clearDataBtn').addEventListener('click', () => {
    document.getElementById('dataInput').value = '';
    parseAndDisplayData(); // å‘¼å«æ­¤å‡½å¼ä¾†è™•ç†æ‰€æœ‰ UI æ›´æ–°
  });
  
  document.getElementById('dataInput').addEventListener('input', parseAndDisplayData);
  document.getElementById('validateDataBtn').addEventListener('click', validateAndProceed);
  
  document.getElementById('backToStep1').addEventListener('click', () => goToStep(1));
  document.getElementById('proceedToStep3').addEventListener('click', () => {
    try {
      // è®€å–ä¸¦é©—è­‰ç”¨æˆ¶æ‰‹å‹•ä¿®æ”¹çš„åƒæ•¸
      const newK = parseFloat(document.getElementById('inputParamK').value);
      const newB = parseFloat(document.getElementById('inputParamB').value);
      const newT0 = parseFloat(document.getElementById('inputParamT0').value);
  
      const validData = state.historicalData.filter(d => !d.isMissing);
      const maxAccounts = Math.max(...validData.map(d => d.accounts));
  
      if (!isFinite(newK) || !isFinite(newB) || !isFinite(newT0)) {
        throw new Error('æ‰€æœ‰åƒæ•¸éƒ½å¿…é ˆæ˜¯æœ‰æ•ˆçš„æ•¸å­—ã€‚');
      }
      if (newK <= maxAccounts) {
        throw new Error(`K (æ‰¿è¼‰å®¹é‡) å¿…é ˆå¤§æ–¼æ­·å²æœ€å¤§å€¼ (${formatNumber(maxAccounts)})ã€‚`);
      }
      if (newB <= 0 || newB > 2.0) { // å…è¨± b ç¨å¾®å¤§æ–¼ 1
        throw new Error('b (æˆé•·ç‡) å¿…é ˆæ˜¯ (0, 2.0] ä¹‹é–“çš„æ•¸å­—ã€‚');
      }
  
      // å°‡ç”¨æˆ¶æ‰‹å‹•ä¿®æ”¹å¾Œçš„åƒæ•¸å„²å­˜å› state
      state.fittedParams.K = newK;
      state.fittedParams.b = newB;
      state.fittedParams.t0 = newT0;
  
      showToast('âœ“ æ‰‹å‹•åƒæ•¸å·²å„²å­˜ã€‚');
      
      // --- é©—è­‰é€šéï¼Œç¹¼çºŒåŸ·è¡Œ ---
      goToStep(3);
  
      // å‹•æ…‹æ›´æ–°å•Ÿå‹•å­£åº¦æ¨™ç±¤
      const lastPeriod = state.historicalData[state.historicalData.length - 1].period;
      const firstFuturePeriod = getNextQuarter(lastPeriod);
      document.getElementById('launchQuarterLabel').textContent = `ï¼ˆ${firstFuturePeriod} = å­£åº¦ 1ï¼‰`;
  
      initializeSliders();
  
    } catch (error) {
      // å¦‚æœé©—è­‰å¤±æ•—ï¼Œå‰‡å½ˆå‡ºæç¤ºä¸¦åœç•™åœ¨æ­¥é©Ÿ 2
      alert(`ç„¡æ³•ç¹¼çºŒ: ${error.message}`);
    }
  });
  
  document.querySelectorAll('.scenario-preset').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const scenario = e.target.dataset.scenario;
      loadScenarioPreset(scenario);
    });
  });
  
  document.getElementById('backToStep2').addEventListener('click', () => goToStep(2));
  document.getElementById('proceedToStep4').addEventListener('click', generateForecasts);
  
  document.getElementById('backToStep3').addEventListener('click', () => goToStep(3));
  document.getElementById('resetAllBtn').addEventListener('click', () => {
    if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
      goToStep(1);
      document.getElementById('dataInput').value = '';
      state.historicalData = [];
      state.fittedParams = null;
      state.forecastData = null;
    }
  });
  
document.getElementById('exportCSVBtn').addEventListener('click', exportCSV);
  
  // --- æ–°å¢ï¼šæ’å€¼å¡ç‰‡äº‹ä»¶ ---
  document.querySelectorAll('input[name="interpolation"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const method = e.target.value;
      const impactDiv = document.getElementById('interpolationImpact');
      
      const descriptions = {
        'ignore': 'è·³éç¼ºæ¼å­£åº¦ã€‚å¦‚æœç¼ºæ¼è¼ƒå°‘ï¼ˆ1-2å€‹ï¼‰ï¼Œé€™æ˜¯å¯è¡Œçš„ç°¡å–®æ–¹æ³•ã€‚',
        'linear': 'åœ¨ç›¸é„°å€¼ä¹‹é–“ç¹ªè£½ç›´ç·šã€‚é©ç”¨æ–¼è¶¨å‹¢è¼ƒç©©å®šçš„æ™‚æœŸã€‚',
        'gompertz': 'ä½¿ç”¨ S å‹æ›²ç·šä¼°è¨ˆã€‚æœ€é©åˆæˆé•·æ•¸æ“šï¼Œé€šå¸¸èƒ½æä¾›æœ€æº–ç¢ºçš„ä¼°è¨ˆã€‚',
        'forward': 'é‡è¤‡å‰ä¸€å€‹å€¼ã€‚ä¿å®ˆæ–¹æ³•ï¼Œé©åˆæˆé•·åœæ»¯æœŸã€‚'
      };
      
      impactDiv.innerHTML = `
        <h4>æ–¹æ³•èªªæ˜</h4>
        <p>${descriptions[method]}</p>
      `;
      impactDiv.style.display = 'block';
    });
  });

  document.getElementById('applyInterpolationBtn').addEventListener('click', applyInterpolation);
  
  // --- æ–°å¢ï¼šé‡æ–°æ“¬åˆæŒ‰éˆ• ---
  document.getElementById('refitKBtn').addEventListener('click', () => {
    const newK = parseFloat(document.getElementById('inputParamK').value);
    const result = refitWithFixedK(newK);
    
    if (result) {
      // æ“¬åˆæˆåŠŸï¼Œæ›´æ–° state å’Œè¼¸å…¥æ¡†
      state.fittedParams = result.params;
      document.getElementById('inputParamB').value = result.params.b.toFixed(4);
      document.getElementById('inputParamT0').value = result.params.t0.toFixed(2);
      
      // æ›´æ–°åœ–è¡¨å’Œç‹€æ…‹
      displayFittingChart();
      const statusEl = document.getElementById('fittingStatus');
      statusEl.innerHTML = `âœ“ å·²å›ºå®š K é‡æ–°æ“¬åˆ (RÂ² = ${result.r2.toFixed(4)})`;
      statusEl.style.color = 'var(--color-success)';
      showToast('âœ“ å·²å›ºå®š K é‡æ–°æ“¬åˆ b, tâ‚€');
    }
  });
  // --- æ–°å¢çµæŸ ---

  document.getElementById('inputParamK').addEventListener('input', updateManualParamsAndChart);
  document.getElementById('inputParamB').addEventListener('input', updateManualParamsAndChart);
  document.getElementById('inputParamT0').addEventListener('input', updateManualParamsAndChart);
  // --- æ–°å¢çµæŸ ---

  initializeSliders();
});
    </script>
</body>
</html>